# Piecewise Linear Regression Models Using a Threshold Decomposition

## Introduction

The Threshold Decomposition algorithm converts a single real value into a vector [1]. If the number of thresholds is Q, 
then the vector contain Q+1 elements. 

If the thresholds are {1, 5} then: 

If $x = 7$ then the threshold decomposition of x is [1, 4, 2].

If x = 4 then the threshold decomposition of x is [1, 3, 0].

If x = 0.5 then the threshold decomposition is [0.5, 0, 0].

If x = -2.3 then the threshold decomposition is [-2.3, 0, 0]

The algorithm simply computes the length of the intersection of the segment [0, x] and the segments
generated by the thresholds: (-inf, 1], (1, 5], (5, inf). If x is negative, the intersection length is considered
negative. The threshold decomposition operation can be applied to a matrix element by element using either a single
threshold vector or different threshold vectors.

A linear regression model with 3 variables uses the following equation: 

                   y = w1 x1 + w2 x2 + w3 x3 + b
                   
where x1, x2, and x3 are the variables, w1, w2, and w3 are the coefficients and b is a bias term. In [1] the authors 
demonstrate that the equivalent equation using threshold-decomposed 
variables represents a continuous multivariate piecewise linear (PWL) function with the
thresholds as the locations of the hinges:

                  y = W1' X1 + W2' X2 + W3' X3 + b
                  
where X1, X2, and X3 are the threshold decomposed variables (column vectors) and W1, W2, and W3 are vector 
coefficients of the same size as their respective X1, X2, or X3 vectors. W1' is the notation used to transpose 
column vector W1 into a row vector. 

In regression problems we have a data matrix X of size M x N where M is the number of points and N is the number 
of variables (features). The column vector Y represents the output of the N variables 
for each of the data points. The size of Y is M x 1. In linear 
regression we try to predict the Y values using the X matrix and the vector of coefficients W = {w1, w2, ...}; that is:

                      Y = X W + b
 
There are many packages for solving linear regression problems and finding the optimal set of coefficients. For
example sklearn has functions for this purpose. The PWL equation shown above shows that a very simple way to generate a piecewise linear model requires: 

1) Perform threshold decomposition on the data matrix X applying threshold to each variable. This process results 
in a extended data matrix Xm
2) Use conventional linear regression (for example from sklearn) to find the piecewise linear coefficients 
Wm = {W1, W2, ...}

The PWL modeling problem can be formulated as finding the optimal the coefficients from:

                     Y = Xm Wm  + b

This simple procedure is the big advantage of threshold decomposition. 
The model-generating algorithm (in this case scikit-learn) remains the same and only the
input data needs to be transformed. The software described here follows this approach.

The files in this repository have the following purpose: 

- thdecomp.py  -  A Python module with functions to perform threshold decomposition of a numeric value or a data matrix
- pwl_regression.py  -  A Python script demonstrating how to build PWL models using threshold decompostion and sklearn
linear regression functions.
- winequality-red.csv  -  The data used in the regression example. It describes wine quality as a function of
several features.

### Prerequisites

1. Python 2.7
2. Python packages NumPy, scikit-learn, and pandas

### Installing

1. Download the python files and the csv file and place them in a folder
2. If you have installed the Python packages in virtual or conda environments make sure to activate the environment

## Running the program and using the thdecomp module

The pwl_regression.py script runs from command line using the command:

                  python pwl_regression.py
                  
The script reads the raw data, creates test and traning sets, and generates linear and piecewise linear models 
for comparison. The script prints detailed information about each of the steps.

You can write your own programs that take advantage of threshold decompostion importing the referenced module: 

                 import thdecomp as th

The different functions available in this module are:

**Xmat = th.multivar_decomp(Xdat, thlist)**  -- Performs threshold decomposition on an MxN data matrix (Xdat; a 
numpy ndarray) using a list of thereshold vectors (thlist; a list of lists). The number of threshold vectors 
must match N (the number of variables). Returns an extended data matrix (Xmat; a numpy ndarray).

**Xmat = th.multivar_decomp_uniform(Xdat, thvec)** -- Performs threshold decomposition on an MxN data matrix 
(Xdat; a numpy ndarray) 
using a single threshold vector (thvec; a list). This vector defines thresholds for each of the N dimensions. 
Returns an extended data matrix (Xmat; a numpy array).

**xvec = th.univar_decomp(xval, thvec)** -- Performs threshold decomposition on a single numeric 
value (xval; a numeric value) using a
vector of thresholds (thvec; a list). Returns a threshold decomposition vector (xvec; a list).

## Authors

Edwin Heredia 

https://github.com/edwhere

http://www.cometglow.com

## References

[1] E. Heredia, G. Arce, "Piecewise linear system modeling based on a continuous threshold decomposition", IEEE 
Trans. on Signal Processing, Vol. 44, No. 6, 1996.


## License

This project is licensed under the MIT License (Expat version)

Copyright (c) 2017 - 2020 Edwin Heredia
 
 Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated 
 documentation files (the "Software"), to deal in the Software without restriction, including without limitation 
 the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and 
 to permit persons to whom the Software is furnished to do so, subject to the following conditions:
 
 The above copyright notice and this permission notice shall be included in all copies or substantial portions 
 of the Software.
 
 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED 
 TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL 
 THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF 
 CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 DEALINGS IN THE SOFTWARE.





